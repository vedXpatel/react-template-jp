{"version":3,"file":"useKeyboardNavigation.js","sources":["../src/common-hooks/useKeyboardNavigation.ts"],"sourcesContent":["import { useControlled } from \"@salt-ds/core\";\nimport {\n  type FocusEvent,\n  type KeyboardEvent,\n  useCallback,\n  useMemo,\n  useRef,\n  useState,\n} from \"react\";\nimport type { CollectionItem } from \"./collectionTypes\";\nimport {\n  ArrowDown,\n  ArrowUp,\n  End,\n  Home,\n  PageDown,\n  PageUp,\n  isCharacterKey,\n  isNavigationKey,\n} from \"./keyUtils\";\nimport type {\n  NavigationHookProps,\n  NavigationHookResult,\n} from \"./navigationTypes\";\nimport {\n  type SelectionStrategy,\n  getFirstSelectedItem,\n  hasSelection,\n} from \"./selectionTypes\";\n\nexport const LIST_FOCUS_VISIBLE = -2;\n\nfunction nextItemIdx(count: number, key: string, idx: number) {\n  if (key === ArrowUp || key === End) {\n    if (idx > 0) {\n      return idx - 1;\n    }\n    return idx;\n  }\n  if (idx === null) {\n    return 0;\n  }\n  if (idx === count - 1) {\n    return idx;\n  }\n  return idx + 1;\n}\n\nconst getIndexOfSelectedItem = (\n  items: CollectionItem<unknown>[],\n  selected?: CollectionItem<unknown> | null | CollectionItem<unknown>[],\n) => {\n  const selectedItem = getFirstSelectedItem(selected);\n  if (selectedItem) {\n    return items.indexOf(selectedItem);\n  }\n  return -1;\n};\n\nconst getStartIdx = (\n  key: string,\n  idx: number,\n  selectedIdx: number,\n  length: number,\n) => {\n  if (key === End) {\n    return length;\n  }\n  if (key === Home) {\n    return -1;\n  }\n  if (idx !== -1) {\n    return idx;\n  }\n  return selectedIdx;\n};\n\nconst getItemRect = (item: CollectionItem<unknown>) => {\n  const el = document.getElementById(item.id);\n  if (el) {\n    return el.getBoundingClientRect();\n  }\n  throw Error(\n    `useKeyboardNavigation.getItemRect no element found for item  #${item?.id}`,\n  );\n};\n\nconst pageDown = (\n  containerEl: HTMLElement,\n  itemEl: HTMLElement,\n  indexPositions: CollectionItem<unknown>[],\n  index: number,\n): number | undefined => {\n  const { top: itemTop } = itemEl.getBoundingClientRect();\n  const { scrollTop, clientHeight, scrollHeight } = containerEl;\n  const lastIndexPosition = indexPositions.length - 1;\n  const newScrollTop = Math.min(\n    scrollTop + clientHeight,\n    scrollHeight - clientHeight,\n  );\n  if (newScrollTop !== scrollTop && index < lastIndexPosition) {\n    containerEl.scrollTo(0, newScrollTop);\n    // Might need to do this in a timeout, in case virtualized content has rendered\n    let nextIdx = index;\n    let nextRect: DOMRect;\n    do {\n      nextIdx += 1;\n      nextRect = getItemRect(indexPositions[nextIdx]);\n    } while (nextRect.top < itemTop && nextIdx < lastIndexPosition);\n    return nextIdx;\n  }\n};\n\nconst pageUp = async (\n  containerEl: HTMLElement,\n  itemEl: HTMLElement,\n  indexPositions: CollectionItem<unknown>[],\n  index: number,\n): Promise<number | undefined> => {\n  const { top: itemTop } = itemEl.getBoundingClientRect();\n  const { scrollTop, clientHeight } = containerEl;\n  const newScrollTop = Math.max(scrollTop - clientHeight, 0);\n  if (newScrollTop !== scrollTop && index > 0) {\n    containerEl.scrollTo(0, newScrollTop);\n    return new Promise((resolve) => {\n      // We must defer this operation until after render. If Items are virtualized.\n      // we need to allow them to be rendered.\n      requestAnimationFrame(() => {\n        let nextIdx = index;\n        let nextRect: DOMRect;\n        do {\n          nextIdx -= 1;\n          nextRect = getItemRect(indexPositions[nextIdx]);\n        } while (nextRect.top > itemTop && nextIdx > 0);\n        resolve(nextIdx);\n      });\n    });\n  }\n};\n\nconst isLeaf = <Item>(item: CollectionItem<Item>): boolean =>\n  !item.header && !item.childNodes;\nconst isFocusable = <Item>(item: CollectionItem<Item>) =>\n  isLeaf(item) || item.expanded !== undefined;\n\nexport const useKeyboardNavigation = <\n  Item,\n  Selection extends SelectionStrategy,\n>({\n  containerRef,\n  defaultHighlightedIndex = -1,\n  disableHighlightOnFocus,\n  highlightedIndex: highlightedIndexProp,\n  indexPositions,\n  onHighlight,\n  onKeyboardNavigation,\n  restoreLastFocus,\n  selected,\n}: NavigationHookProps<Item, Selection>): NavigationHookResult => {\n  const lastFocus = useRef(-1);\n  const [, forceRender] = useState({});\n  const [highlightedIndex, setHighlightedIdx, isControlledHighlighting] =\n    useControlled({\n      controlled: highlightedIndexProp,\n      default: defaultHighlightedIndex,\n      name: \"UseKeyboardNavigation\",\n    });\n\n  const setHighlightedIndex = useCallback(\n    (idx: number, fromKeyboard = false) => {\n      onHighlight?.(idx);\n      setHighlightedIdx(idx);\n      if (fromKeyboard) {\n        lastFocus.current = idx;\n      }\n    },\n    [onHighlight],\n  );\n\n  const nextPageItemIdx = useCallback(\n    async (e: KeyboardEvent, index: number): Promise<number> => {\n      const { id } = indexPositions[index];\n      let result: number | undefined;\n      if (id) {\n        const itemEl = document.getElementById(id);\n        const { current: containerEl } = containerRef;\n        if (itemEl && containerEl) {\n          result =\n            e.key === PageDown\n              ? pageDown(containerEl, itemEl, indexPositions, index)\n              : await pageUp(containerEl, itemEl, indexPositions, index);\n        }\n      }\n      return result ?? index;\n    },\n    [containerRef, indexPositions],\n  );\n\n  const nextFocusableItemIdx = useCallback(\n    (\n      key = ArrowDown,\n      idx: number = key === ArrowDown ? -1 : indexPositions.length,\n    ) => {\n      if (indexPositions.length === 0) {\n        return -1;\n      }\n      const indexOfSelectedItem = getIndexOfSelectedItem(\n        indexPositions,\n        selected,\n      );\n      // The start index is generally the highlightedIdx (passed in as idx).\n      // We don't need it for Home and End navigation.\n      // Special case where we have selection, but no highlighting - begin\n      // navigation from selected item.\n      const startIdx = getStartIdx(\n        key,\n        idx,\n        indexOfSelectedItem,\n        indexPositions.length,\n      );\n\n      let nextIdx = nextItemIdx(indexPositions.length, key, startIdx);\n      // Guard against returning zero, when first item is a header or group\n      if (nextIdx === 0 && key === ArrowUp && !isFocusable(indexPositions[0])) {\n        return idx;\n      }\n      while (\n        (((key === ArrowDown || key === Home) &&\n          nextIdx < indexPositions.length) ||\n          ((key === ArrowUp || key === End) && nextIdx > 0)) &&\n        !isFocusable(indexPositions[nextIdx])\n      ) {\n        nextIdx = nextItemIdx(indexPositions.length, key, nextIdx);\n      }\n      return nextIdx;\n    },\n    [indexPositions, selected],\n  );\n\n  // does this belong here or should it be a method passed in?\n  const keyboardNavigation = useRef(false);\n  const ignoreFocus = useRef<boolean>(false);\n  const setIgnoreFocus = useCallback(\n    (value: boolean) => (ignoreFocus.current = value),\n    [],\n  );\n\n  const handleFocus = useCallback(() => {\n    // Ignore focus if mouse has been used\n    if (ignoreFocus.current) {\n      ignoreFocus.current = false;\n    } else {\n      // If mouse wan't used, then keyboard must have been\n      keyboardNavigation.current = true;\n      if (indexPositions.length === 0) {\n        setHighlightedIndex(LIST_FOCUS_VISIBLE);\n      } else if (highlightedIndex !== -1) {\n        // We need to force a render here. We're not changing the highlightedIdx, but we want to\n        // make sure we render with the correct focusVisible value. We don't store focusVisible\n        // in state, as there are places where we would double render, as highlightedIdx also changes.\n        forceRender({});\n      } else if (restoreLastFocus) {\n        if (lastFocus.current !== -1) {\n          setHighlightedIndex(lastFocus.current);\n        } else {\n          const selectedItemIdx = getIndexOfSelectedItem(\n            indexPositions,\n            selected,\n          );\n          if (selectedItemIdx !== -1) {\n            setHighlightedIndex(selectedItemIdx);\n          } else {\n            setHighlightedIndex(0);\n          }\n        }\n      } else if (hasSelection(selected)) {\n        const selectedItemIdx = getIndexOfSelectedItem(\n          indexPositions,\n          selected,\n        );\n        setHighlightedIndex(selectedItemIdx);\n      } else if (disableHighlightOnFocus !== true) {\n        setHighlightedIndex(nextFocusableItemIdx());\n      }\n    }\n  }, [\n    disableHighlightOnFocus,\n    highlightedIndex,\n    indexPositions,\n    nextFocusableItemIdx,\n    restoreLastFocus,\n    selected,\n    setHighlightedIndex,\n  ]);\n\n  const navigateChildItems = useCallback(\n    async (e: KeyboardEvent) => {\n      const nextIdx =\n        e.key === PageDown || e.key === PageUp\n          ? await nextPageItemIdx(e, highlightedIndex)\n          : nextFocusableItemIdx(e.key, highlightedIndex);\n\n      if (nextIdx !== highlightedIndex) {\n        setHighlightedIndex(nextIdx, true);\n      }\n      // Users may need to know that a Keyboard navigation event has been handled\n      // even if no actual navigation was effected. e.g. fine-grained control\n      // over aria-activedescendant requires this.\n      onKeyboardNavigation?.(e, nextIdx);\n    },\n    [\n      highlightedIndex,\n      nextFocusableItemIdx,\n      nextPageItemIdx,\n      onKeyboardNavigation,\n      setHighlightedIndex,\n    ],\n  );\n\n  const handleKeyDown = useCallback(\n    (e: KeyboardEvent) => {\n      if (indexPositions.length > 0 && isNavigationKey(e)) {\n        e.preventDefault();\n        e.stopPropagation();\n        keyboardNavigation.current = true;\n        void navigateChildItems(e);\n      } else if (isCharacterKey(e)) {\n        keyboardNavigation.current = true;\n      }\n    },\n    [indexPositions, navigateChildItems],\n  );\n\n  const listProps = useMemo(() => {\n    return {\n      onBlur: (e: FocusEvent) => {\n        //TODO no direct ref to List\n        const sourceTarget = (e.target as HTMLElement).closest(\".saltList\");\n        const destTarget = e.relatedTarget as HTMLElement;\n        if (sourceTarget && !sourceTarget?.contains(destTarget)) {\n          keyboardNavigation.current = false;\n          setHighlightedIdx(-1);\n          if (!restoreLastFocus) {\n            lastFocus.current = -1;\n          }\n        }\n      },\n      onFocus: handleFocus,\n      onKeyDown: handleKeyDown,\n      onMouseDownCapture: () => {\n        keyboardNavigation.current = false;\n        setIgnoreFocus(true);\n      },\n\n      // onMouseEnter would seem less expensive but it misses some cases\n      onMouseMove: () => {\n        if (keyboardNavigation.current) {\n          keyboardNavigation.current = false;\n        }\n      },\n      onMouseLeave: () => {\n        keyboardNavigation.current = false;\n        setIgnoreFocus(false);\n        setHighlightedIndex(-1);\n      },\n    };\n  }, [\n    handleFocus,\n    handleKeyDown,\n    restoreLastFocus,\n    setHighlightedIndex,\n    setIgnoreFocus,\n  ]);\n\n  return {\n    focusVisible: keyboardNavigation.current ? highlightedIndex : -1,\n    controlledHighlighting: isControlledHighlighting,\n    highlightedIndex,\n    setHighlightedIndex,\n    keyboardNavigation,\n    listProps,\n    setIgnoreFocus,\n  };\n};\n"],"names":["ArrowUp","End","getFirstSelectedItem","Home","useRef","useState","useControlled","useCallback","PageDown","ArrowDown","hasSelection","PageUp","isNavigationKey","isCharacterKey","useMemo"],"mappings":"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"}